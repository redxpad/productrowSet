# Установка/изменение товарных позиций

Для доступа к REST API Bitrix24 запросите у интегратора вебхук, или создайте его самостоятельно на своем портале в разделе Разработчикам-> Другое-> Входящий вебхук. Если создаете вебхук самостоятельно выберите методы к которым у вебхука будет доступ. Для создания/изменения товырных позиций сделки потребуются права на доступ к методам crm.

Полученный вебхук добавляем в файл settings.php в 'C_REST_WEB_HOOK_URL'.

Для вызова методов Rest API Bitrix24 можно использовать метод "call" класса CRest описанный в файле crest.php. Метод принимает в качестве первого аргумента строку - название вызываемого метода, например 'crm.deal.update', а вторым аргументом набор параметров описанных в документации.

## Доступные поля товарных позиций

Чтобы узнать доступные поля для заполнения к товарным позициям вызовите метод [crm.productrow.fields](https://dev.1c-bitrix.ru/rest_help/crm/productrow_old/crm_productrow_fields.php), метод вызывается без параметров и возвращает список полей с названиями и типами, у обязательных полей  isRequired имеет значение - "1". Такие поля как ID, OWNER_ID и OWNER_TYPE указывать не нужно, ID устанавливается автоматически, а ID и TYPE родительской сущности не нужно так как мы добавляем товарные позиции для конкретной сделки.
Пример кода в файле getFieldsExample.php

## Установка товарных позиций

Для установки товарных позиций в сделке неиходимо использовать метод [crm.deal.productrows.set](https://dev.1c-bitrix.ru/rest_help/crm/cdeals/crm_deal_productrows_set.php), метод принимает первым аргументом ID сделки, а вторым массив товарных позиций, каждая из которых состоит из массива параметров товарной позиции. Проверить добавленные товарные позиции или уже существующие в сделке  можно использовать метод [crm.deal.productrows.get](https://dev.1c-bitrix.ru/rest_help/crm/cdeals/crm_deal_productrows_get.php). Если в сделке уже есть товарные позиции и вы попытаетесь передать туда новые, то старые товарные перезапишутся только теми что вы передали в crm.deal.productrows.set. Для правильной дозаписи необходимо получить уже имеющиеся товарные позиции и добавить к ним новые, затем все вместе передать методу.
Пример кода в файле setProductsExample.php

## Получение ID торговой позиции
Для того чтобы получить PRODUCT_ID из crm необходимо использовать метод [crm.product.list](https://dev.1c-bitrix.ru/rest_help/catalog/product/catalog_product_list.php), для сопоставления ID товарной позиции на сайте и ID товарной позиции в crm используется пользовательское поле, в котором хранится ID товарной позиции на сайте, в примере это поле - PROPERTY_414, чтобы узнать идентификатор этого поля обратитесь к интегратору.
Пример кода в файле getProductsExample.php

## Добавление товарной позиции
Если не удалось найти товарную позицию в crm можно создать новую с помощью метода [catalog.product.add](https://dev.1c-bitrix.ru/rest_help/catalog/product/catalog_product_add.php), необходимо передать массив полей для создания новой позиции, поля name и iblockId являются обязательными.
В ответе метод вернет созданную товарную позицию вместе с его ID, который можно использовать в методе crm.deal.productrows.set в качестве PRODUCT_ID.
Пример кода в файле addProductExample.php
